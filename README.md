<div align="center">

<img src="logo/riskva_logo.svg" alt="RisKVA Logo" width="400"/>

# RisKVA - Risk Assessment VLM Assistant

**åŸºäºè§†è§‰è¯­è¨€æ¨¡å‹(VLM)çš„æ™ºèƒ½é£é™©è¯„ä¼°åŠ©æ‰‹ï¼Œä¸“æ³¨äºå·¥ç¨‹ç¼ºé™·æ£€æµ‹å’Œé£é™©ç­‰çº§è¯„ä¼°**

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://python.org)
[![PyTorch](https://img.shields.io/badge/PyTorch-2.0+-orange.svg)](https://pytorch.org)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![Status](https://img.shields.io/badge/Status-Active-brightgreen.svg)]()

[ğŸš€ å¿«é€Ÿå¼€å§‹](#ğŸš€-å¿«é€Ÿå¼€å§‹) â€¢ [ğŸ“Š æ•°æ®é›†](#ğŸ—‚ï¸-æ•°æ®é›†) â€¢ [ğŸ› ï¸ å®‰è£…ä½¿ç”¨](#ğŸ› ï¸-å®‰è£…ä¸ä½¿ç”¨) â€¢ [ğŸ—ï¸ ç³»ç»Ÿæ¶æ„](#ğŸ—ï¸-ç³»ç»Ÿæ¶æ„) â€¢ [ğŸ“ å¼€å‘è·¯çº¿å›¾](#ğŸ“-å¼€å‘è·¯çº¿å›¾ä¸å¾…åŠäº‹é¡¹)

---

</div>

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

RisKVA æ˜¯ä¸€ä¸ªåŸºäºè§†è§‰è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½é£é™©è¯„ä¼°ç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºå»ºç­‘å·¥ç¨‹ç¼ºé™·æ£€æµ‹å’Œé£é™©ç­‰çº§è¯„ä¼°ã€‚é¡¹ç›®è‡´åŠ›äºé€šè¿‡å…ˆè¿›çš„å¤šæ¨¡æ€AIæŠ€æœ¯ï¼Œè‡ªåŠ¨åŒ–è¯†åˆ«å»ºç­‘å·¥ç¨‹ä¸­çš„è´¨é‡ç¼ºé™·ï¼Œå¹¶æä¾›ä¸“ä¸šçš„é£é™©è¯„ä¼°å’Œæ•´æ”¹å»ºè®®ã€‚

### é¡¹ç›®ç›®çš„
- æé«˜å»ºç­‘å·¥ç¨‹è´¨é‡æ£€æµ‹çš„æ•ˆç‡å’Œå‡†ç¡®æ€§
- æ ‡å‡†åŒ–ç¼ºé™·è¯†åˆ«å’Œé£é™©è¯„ä¼°æµç¨‹
- å‡å°‘äººå·¥æ£€æµ‹çš„ä¸»è§‚æ€§å’Œé—æ¼é£é™©
- ä¸ºå·¥ç¨‹è´¨é‡ç®¡ç†æä¾›æ™ºèƒ½åŒ–è§£å†³æ–¹æ¡ˆ

### ä¸»è¦åŠŸèƒ½
- **å¤šæ¨¡æ€ç¼ºé™·è¯†åˆ«**ï¼šç»“åˆå›¾åƒå’Œæ–‡æœ¬ä¿¡æ¯è¿›è¡Œç¼ºé™·æ£€æµ‹
- **æ™ºèƒ½é£é™©è¯„ä¼°**ï¼šè‡ªåŠ¨è¯„ä¼°ç¼ºé™·çš„é£é™©ç­‰çº§å’Œå½±å“ç¨‹åº¦
- **ä¸“ä¸šå»ºè®®ç”Ÿæˆ**ï¼šæä¾›é’ˆå¯¹æ€§çš„çº æ­£å’Œé¢„é˜²å»ºè®®
- **æ‰¹é‡å¤„ç†èƒ½åŠ›**ï¼šæ”¯æŒå¤§è§„æ¨¡å·¥ç¨‹æ•°æ®çš„è‡ªåŠ¨åŒ–åˆ†æ

### æŠ€æœ¯æ ˆæ¦‚è¿°
- **åŸºç¡€æ¡†æ¶**ï¼šPyTorch, Transformers, TRL
- **æ ¸å¿ƒæ¨¡å‹**ï¼šQwen2.5-VLç³»åˆ—è§†è§‰è¯­è¨€æ¨¡å‹
- **è®­ç»ƒåŠ é€Ÿ**ï¼šDeepSpeed, PEFT (LoRA), Flash Attention
- **æ•°æ®å¤„ç†**ï¼šDatasets, Pandas, PIL
- **åˆ†å¸ƒå¼è®­ç»ƒ**ï¼šAccelerate, å¤šGPUæ”¯æŒ
- **ç›‘æ§å·¥å…·**ï¼šTensorBoard, Weights & Biases

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

1. **ç¼ºé™·è¯†åˆ«ä¸åˆ†ç±»**
   - å¤šç§å»ºç­‘ç¼ºé™·ç±»å‹è‡ªåŠ¨è¯†åˆ«ï¼ˆæ¸—æ°´ã€å¼€è£‚ã€è„±è½ç­‰ï¼‰
   - åŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒç‰¹å¾æå–
   - æ”¯æŒå¤æ‚åœºæ™¯ä¸‹çš„ç¼ºé™·å®šä½

2. **é£é™©ç­‰çº§è¯„ä¼°**
   - äº”çº§é£é™©åˆ†ç±»ä½“ç³»ï¼ˆA-æ­£å¸¸ã€B-è½»å¾®ã€C-ä¸­ç­‰ã€D-ä¸¥é‡ã€E-ä¸¥é‡è´¨é‡è¡Œä¸ºé£é™©ï¼‰
   - åŸå§‹é£é™©ä¸å½“å‰é£é™©çŠ¶æ€å¯¹æ¯”
   - åŸºäºè¡Œä¸šæ ‡å‡†çš„è¯„ä¼°å‡†åˆ™

3. **æ™ºèƒ½å»ºè®®ç”Ÿæˆ**
   - ä¸ªæ€§åŒ–çº æ­£æªæ–½å»ºè®®
   - é¢„é˜²æ€§ç»´æŠ¤æŒ‡å¯¼
   - ç¬¦åˆå·¥ç¨‹å®è·µçš„ä¸“ä¸šå»ºè®®

4. **æ¨¡å‹è®­ç»ƒä¸ä¼˜åŒ–**
   - æ”¯æŒ3Bã€7Bã€32Bç­‰å¤šç§è§„æ¨¡æ¨¡å‹
   - PEFTæŠ€æœ¯å®ç°é«˜æ•ˆå¾®è°ƒ
   - å†…å­˜ä¼˜åŒ–å’Œæ¢¯åº¦æ£€æŸ¥ç‚¹
   - åˆ†å¸ƒå¼è®­ç»ƒæ”¯æŒ

5. **æ¨ç†å¼•æ“**
   - å®æ—¶å›¾åƒåˆ†æ
   - æ‰¹é‡æ•°æ®å¤„ç†
   - å¤šç§è¾“å…¥æ ¼å¼æ”¯æŒ
   - çµæ´»çš„éƒ¨ç½²é€‰é¡¹

## ğŸ› ï¸ å®‰è£…ä¸ä½¿ç”¨

### ç¯å¢ƒè¦æ±‚

- **ç¡¬ä»¶è¦æ±‚**
  - GPU: NVIDIA RTX 3090/4090 æˆ–æ›´é«˜ (æ¨è24GB+ æ˜¾å­˜)
  - CPU: 8æ ¸å¿ƒä»¥ä¸Š
  - å†…å­˜: 32GBä»¥ä¸Š
  - å­˜å‚¨: 100GBå¯ç”¨ç©ºé—´

- **è½¯ä»¶ç¯å¢ƒ**
  - Python 3.8+
  - CUDA 11.8+
  - Linux/Ubuntu (æ¨è)

### å®‰è£…ä¾èµ–æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone https://github.com/your-repo/RisKVA.git
cd RisKVA
```

2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
```bash
conda create -n riskva python=3.10
conda activate riskva
```

3. **å®‰è£…ä¾èµ–åŒ…**
```bash
pip install -r requirements.txt

# Flash Attentionéœ€è¦å•ç‹¬å®‰è£…
pip install flash-attn --no-build-isolation -v
```

4. **ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹**
```bash
# ä½¿ç”¨æä¾›çš„è„šæœ¬ä¸‹è½½Qwen2.5-VLæ¨¡å‹
cd models/pretrained_models
bash hfd.sh
```

### é…ç½®æ–‡ä»¶

- **è®­ç»ƒé…ç½®**: `configs/accelerate_configs/` - DeepSpeedå’Œå¤šGPUé…ç½®
- **æç¤ºè¯é…ç½®**: `configs/prompt_configs/building_risk_prompts.yaml` - é£é™©æ£€æµ‹æç¤ºè¯æ¨¡æ¿
- **ç¯å¢ƒé…ç½®**: å¤åˆ¶`.env.example`åˆ°`.env`å¹¶é…ç½®ç›¸å…³è·¯å¾„

### å¯åŠ¨å‘½ä»¤æˆ–è¿è¡Œæ­¥éª¤

#### æ¨¡å‹è®­ç»ƒ
```bash
# 7Bæ¨¡å‹è®­ç»ƒ
bash scripts/RisKVA/train_subunit_risk_7b.sh

# 3Bæ¨¡å‹è®­ç»ƒ
bash scripts/RisKVA/train_subunit_risk_3b.sh

# ä½¿ç”¨PEFTè¿›è¡Œé«˜æ•ˆè®­ç»ƒ
bash scripts/RisKVA/train_subunit_risk_7b_peft.sh
```

#### æ¨¡å‹æ¨ç†
```bash
# Python APIè°ƒç”¨
python src/sft_subnunit_risk/inference.py \
    --model_path models/finetuned_models/RisKVA/RisKVA-Qwen2.5-VL-7B-Instruct-sft-subunit-risk \
    --image_path path/to/your/image.jpg \
    --output_format json
```

## ğŸ—‚ï¸ æ•°æ®é›†

### æ•°æ®é›†æ¥æº
- **ä¸»è¦æ•°æ®é›†**: Subunit-Risk åˆ†æˆ·æ£€æŸ¥æ•°æ®é›†
- **æ•°æ®è§„æ¨¡**: 3,771ä¸ªå›¾åƒ-æ–‡æœ¬å¯¹
- **æ•°æ®èŒƒå›´**: å»ºç­‘å·¥ç¨‹ç¼ºé™·æ£€æµ‹ä¸é£é™©è¯„ä¼°
- **æ ‡æ³¨è´¨é‡**: ä¸“ä¸šå·¥ç¨‹å¸ˆäººå·¥æ ‡æ³¨

### æ•°æ®é›†ç»“æ„è¯´æ˜

```
datasets/RisKVA/Subunit-Risk_original/
â”œâ”€â”€ images/                     # ç¼ºé™·å›¾ç‰‡ç›®å½•
â”‚   â”œâ”€â”€ 000000_00_SR-FH-1-20250611-000.jpg
â”‚   â”œâ”€â”€ 000001_00_SR-FH-1-20250611-001.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ metadata.csv               # ä¸»è¦æ•°æ®æ–‡ä»¶
â”œâ”€â”€ metadata_with_image.csv    # åŒ…å«å›¾ç‰‡ä¿¡æ¯çš„å…ƒæ•°æ®
â””â”€â”€ dataset_info.json         # æ•°æ®é›†ä¿¡æ¯æ–‡ä»¶
```

**æ•°æ®æ ¼å¼è¯´æ˜**:
- **å›¾åƒæ ¼å¼**: JPG/PNGï¼Œä¸»è¦å°ºå¯¸ 394x315
- **æ ‡ç­¾æ ¼å¼**: CSVæ–‡ä»¶åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  - `file_id`: æ–‡ä»¶æ ‡è¯†ç¬¦
  - `defect_description_text`: ç¼ºé™·æè¿°
  - `risk_detail`: é£é™©è¯¦æƒ…
  - `correction_suggestion`: çº æ­£å»ºè®®
  - `risk_level_original`: åŸå§‹é£é™©ç­‰çº§
  - `risk_level_current`: å½“å‰é£é™©ç­‰çº§
  - `image_count`: å›¾ç‰‡æ•°é‡
  - `all_image_paths`: å›¾ç‰‡è·¯å¾„åˆ—è¡¨

### ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®é›†çš„è¯´æ˜

1. **æ•°æ®æ ¼å¼è¦æ±‚**
   - å›¾ç‰‡æ ¼å¼: JPG/PNG/BMP
   - å…ƒæ•°æ®: CSVæ ¼å¼ï¼ŒåŒ…å«å¿…è¦å­—æ®µ
   - ç›®å½•ç»“æ„: å‚è€ƒç°æœ‰æ•°æ®é›†ç»„ç»‡æ–¹å¼

2. **æ•°æ®é¢„å¤„ç†å·¥å…·**
```bash
# ä½¿ç”¨æ•°æ®é¢„å¤„ç†è„šæœ¬
cd scripts/prepare_dataset

# Excelè½¬CSV
python get_text.py -i /path/to/excel/files -o /path/to/csv/output

# æ•°æ®æ¸…ç†
python format_csv.py

# ç”Ÿæˆæ•°æ®é›†
python get_datasets.py
```

3. **æ•°æ®éªŒè¯**
```bash
# æ£€æŸ¥æ•°æ®é›†æ ¼å¼
python load_dataset_demo.py
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### ç»„ä»¶æ¦‚è¿°

RisKVAç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

1. **æ•°æ®é¢„å¤„ç†æ¨¡å—** (`scripts/prepare_dataset/`)
   - Excelæ•°æ®è½¬æ¢
   - å›¾åƒæ ¼å¼æ ‡å‡†åŒ–
   - æ•°æ®æ¸…ç†å’ŒéªŒè¯
   - æ•°æ®é›†æ ¼å¼è½¬æ¢

2. **æ¨¡å‹è®­ç»ƒæ¨¡å—** (`src/sft_subnunit_risk/train.py`)
   - å¤šæ¨¡æ€æ•°æ®åŠ è½½
   - æ¨¡å‹å¾®è°ƒè®­ç»ƒ
   - å†…å­˜ä¼˜åŒ–ç®¡ç†
   - åˆ†å¸ƒå¼è®­ç»ƒåè°ƒ

3. **æ¨ç†å¼•æ“** (`src/sft_subnunit_risk/inference.py`)
   - å®æ—¶å›¾åƒåˆ†æ
   - æ‰¹é‡æ•°æ®å¤„ç†
   - ç»“æœæ ¼å¼åŒ–è¾“å‡º
   - APIæ¥å£å°è£…

4. **é…ç½®ç®¡ç†** (`configs/`)
   - è®­ç»ƒè¶…å‚æ•°é…ç½®
   - åŠ é€Ÿå™¨é…ç½®æ–‡ä»¶
   - æç¤ºè¯æ¨¡æ¿ç®¡ç†
   - ç¯å¢ƒå˜é‡é…ç½®

### ç³»ç»Ÿå·¥ä½œæµç¨‹

```mermaid
graph TD
    A[åŸå§‹æ•°æ®] --> B[æ•°æ®é¢„å¤„ç†]
    B --> C[æ•°æ®é›†ç”Ÿæˆ]
    C --> D[æ¨¡å‹è®­ç»ƒ]
    D --> E[æ¨¡å‹è¯„ä¼°]
    E --> F[æ¨ç†éƒ¨ç½²]
    F --> G[ç¼ºé™·æ£€æµ‹]
    G --> H[é£é™©è¯„ä¼°]
    H --> I[å»ºè®®ç”Ÿæˆ]
    
    subgraph "æ ¸å¿ƒç»„ä»¶"
        J[è§†è§‰è¯­è¨€æ¨¡å‹]
        K[å¤šæ¨¡æ€èåˆ]
        L[é£é™©åˆ†ç±»å™¨]
    end
    
    D --> J
    J --> K
    K --> L
    L --> H
```

### æŠ€æœ¯æ¶æ„ç‰¹ç‚¹

- **å¤šæ¨¡æ€èåˆ**: ç»“åˆå›¾åƒè§†è§‰ç‰¹å¾å’Œæ–‡æœ¬è¯­ä¹‰ä¿¡æ¯
- **ç«¯åˆ°ç«¯è®­ç»ƒ**: ä»åŸå§‹æ•°æ®åˆ°æœ€ç»ˆé¢„æµ‹çš„å®Œæ•´æµç¨‹
- **æ¨¡å—åŒ–è®¾è®¡**: å„ç»„ä»¶ç‹¬ç«‹å¼€å‘å’Œç»´æŠ¤
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ–°çš„ç¼ºé™·ç±»å‹å’Œè¯„ä¼°æ ‡å‡†
- **é«˜æ€§èƒ½ä¼˜åŒ–**: å†…å­˜ç®¡ç†ã€æ¢¯åº¦ç´¯ç§¯ã€æ··åˆç²¾åº¦è®­ç»ƒ

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
RisKVA/
â”œâ”€â”€ src/                           # æºä»£ç ç›®å½•
â”‚   â””â”€â”€ sft_subunit_risk/         # åˆ†æˆ·é£é™©è¯„ä¼°æ¨¡å—
â”‚       â”œâ”€â”€ train.py               # æ¨¡å‹è®­ç»ƒè„šæœ¬
â”‚       â””â”€â”€ inference.py           # æ¨ç†è„šæœ¬
â”œâ”€â”€ scripts/                       # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ prepare_dataset/           # æ•°æ®é¢„å¤„ç†å·¥å…·
â”‚   â””â”€â”€ RisKVA/                    # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ datasets/                      # æ•°æ®é›†ç›®å½•
â”‚   â””â”€â”€ RisKVA/                    # RisKVAä¸“ç”¨æ•°æ®é›†
â”œâ”€â”€ models/                        # æ¨¡å‹ç›¸å…³æ–‡ä»¶
â”‚   â”œâ”€â”€ pretrained_models/         # é¢„è®­ç»ƒæ¨¡å‹
â”‚   â””â”€â”€ finetuned_models/          # å¾®è°ƒåæ¨¡å‹
â”œâ”€â”€ configs/                       # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ accelerate_configs/        # åŠ é€Ÿå™¨é…ç½®
â”‚   â””â”€â”€ prompt_configs/            # æç¤ºè¯é…ç½®
â”œâ”€â”€ experiments/                   # å®éªŒè®°å½•
â”œâ”€â”€ logs/                         # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ requirements.txt              # ä¾èµ–é…ç½®
â””â”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

1. **ç¯å¢ƒå‡†å¤‡**: å‚è€ƒå®‰è£…æŒ‡å—è®¾ç½®ç¯å¢ƒ
2. **æ•°æ®å‡†å¤‡**: ä¸‹è½½æˆ–å‡†å¤‡è®­ç»ƒæ•°æ®
3. **æ¨¡å‹è®­ç»ƒ**: è¿è¡Œè®­ç»ƒè„šæœ¬
4. **æ¨¡å‹æ¨ç†**: ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹

## ğŸ“Š æ€§èƒ½è¯„ä¼°

- æ”¯æŒå¤šç§è¯„ä¼°æŒ‡æ ‡
- è‡ªåŠ¨ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
- ä¸åŸºå‡†æ¨¡å‹å¯¹æ¯”åˆ†æ

## ğŸ”§ é…ç½®è¯´æ˜

è¯¦ç»†çš„é…ç½®é€‰é¡¹è¯·å‚è€ƒ `configs/` ç›®å½•ä¸‹çš„ç›¸å…³æ–‡ä»¶ã€‚

## ğŸ“ å¼€å‘è·¯çº¿å›¾ä¸å¾…åŠäº‹é¡¹

### ğŸ¯ å½“å‰ç‰ˆæœ¬ç›®æ ‡ (v1.0)
- [x] âœ… åŸºç¡€VLMè®­ç»ƒæ¡†æ¶æ­å»º
- [x] âœ… Subunit-Riskæ•°æ®é›†é›†æˆ
- [x] âœ… Qwen2.5-VLæ¨¡å‹é€‚é…
- [x] âœ… å¤šGPUè®­ç»ƒä¼˜åŒ–
- [x] âœ… ä¼˜åŒ–æ˜¾å­˜å’Œå†…å­˜çš„åƒåœ¾å¤„ç†
- [x] âœ… ä½¿ç”¨flashattentionä¼˜åŒ–è®­ç»ƒæ€§èƒ½
- [x] âœ… å®Œå–„prompt
- [ ] ğŸ“‹ å›¾åƒå¢å¼ºå¤„ç†
- [ ] ğŸ“‹ è®­ç»ƒ32Bæ¨¡å‹

### ğŸš€ ä¸‹ä¸€ç‰ˆæœ¬è§„åˆ’ (v1.1)
- [ ] ğŸ“‹ GRPOè®­ç»ƒä»£ç æ¡†æ¶
- [ ] ğŸ“‹ ä½¿ç”¨ligerlossä¼˜åŒ–è®­ç»ƒæ€§èƒ½
- [ ] ğŸ“‹ Webç•Œé¢å¼€å‘
- [ ] ğŸ“‹ æ‰¹é‡æ¨ç†æ€§èƒ½æå‡

### ğŸ”§ æŠ€æœ¯å€ºåŠ¡
- [ ] ğŸ“‹ ä»£ç é‡æ„ï¼šè®­ç»ƒæµç¨‹æ¨¡å—åŒ–
- [ ] ğŸ“‹ æ–‡æ¡£å®Œå–„ï¼šAPIæ–‡æ¡£ç”Ÿæˆ
- [ ] ğŸ“‹ æµ‹è¯•è¦†ç›–ï¼šå•å…ƒæµ‹è¯•æ·»åŠ 
- [ ] ğŸ“‹ é…ç½®ç®¡ç†ï¼šç¯å¢ƒå˜é‡ç»Ÿä¸€

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä»»åŠ¡
- [ ] ğŸ“‹ å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- [ ] ğŸ“‹ è®­ç»ƒé€Ÿåº¦æå‡
- [ ] ğŸ“‹ æ¨ç†å»¶è¿Ÿé™ä½
- [ ] ğŸ“‹ æ¨¡å‹ç²¾åº¦æ”¹è¿›

> ğŸ’¡ **ä»»åŠ¡çŠ¶æ€è¯´æ˜ï¼š** âœ… å·²å®Œæˆ | ğŸ”„ è¿›è¡Œä¸­ | ğŸ“‹ å¾…å¼€å§‹

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ã€‚